# üìä NDI VIEW –¥–ª—è PostgreSQL

## –û–ø–∏—Å–∞–Ω–∏–µ

**VIEW:** `sberindex.vw_ndi_calculation`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –†–∞—Å—á—ë—Ç Northern Development Index (NDI) –¥–ª—è –≤—Å–µ—Ö 128 –∞—Ä–∫—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–∞—Å–µ–ª—ë–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º 6 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.

**–§–æ—Ä–º—É–ª–∞:**
```
NDI = 0.35√óPOAD + 0.20√óMarket_Access + 0.15√óConsumption + 0.15√óAccessibility + 0.10√óClimate + 0.05√óMobility
```

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã NDI

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –í–µ—Å | –û–ø–∏—Å–∞–Ω–∏–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö |
|-----------|-----|----------|-----------------|
| **POAD** | 35% | –ö–∞—á–µ—Å—Ç–≤–æ –∂–∏–∑–Ω–∏ (93 –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è, 7 –¥–æ–º–µ–Ω–æ–≤) | `sberindex.poad_attractiveness_v1` |
| **Market Access** | 20% | –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ä—ã–Ω–∫–æ–≤ (—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª) | `sberindex.market_access_municipality` |
| **Consumption** | 15% | –†–µ–∞–ª—å–Ω–æ–µ –±–ª–∞–≥–æ—Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ / –ø—Ä–æ–∂–∏—Ç. –º–∏–Ω–∏–º—É–º) | `sberindex.consumption_municipality` |
| **Accessibility** | 15% | –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–æ 12 –∫—Ä—É–ø–Ω—ã—Ö —Ö–∞–±–æ–≤ | `sberindex.accessibility_scores` |
| **Climate** | 10% | –ö–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (HDD –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω) | `sberindex.agg_climate_summary` |
| **Mobility** | 5% | –ú–æ–±–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞—Å–µ–ª–µ–Ω–∏—è (placeholder: 0.5) | N/A |

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≤ PostgreSQL

```bash
python scripts/12_load_ndi_components_to_postgres.py
```

–ó–∞–≥—Ä—É–∂–∞–µ—Ç:
- `sberindex.poad_attractiveness_v1` (POAD scores)
- `sberindex.accessibility_scores` (–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ö–∞–±–æ–≤)

### 2. –°–æ–∑–¥–∞–Ω–∏–µ VIEW

```bash
psql -f scripts/12_create_ndi_view.sql
```

–ò–ª–∏ —á–µ—Ä–µ–∑ Python:
```python
import psycopg2

conn = psycopg2.connect(
    host='localhost',
    port=5432,
    database='platform',
    user='bot_etl_user2',
    password='allen'
)

with open('scripts/12_create_ndi_view.sql', 'r', encoding='utf-8') as f:
    sql = f.read()

cursor = conn.cursor()
cursor.execute(sql)
conn.commit()
cursor.close()
conn.close()
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ VIEW

### –ö–æ–ª–æ–Ω–∫–∏

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| `settlement_id` | INTEGER | ID –Ω–∞—Å–µ–ª—ë–Ω–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ |
| `settlement_name` | VARCHAR | –ù–∞–∑–≤–∞–Ω–∏–µ –ù–ü |
| `settlement_type` | VARCHAR | –¢–∏–ø (–ø–≥—Ç, —Å–µ–ª–æ, –ø–æ—Å—ë–ª–æ–∫) |
| `region_name` | VARCHAR | –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞ |
| `poad_score` | NUMERIC(15,4) | POAD –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (0-1) |
| `market_score` | NUMERIC(15,4) | Market Access –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (0-1) |
| `consumption_score` | NUMERIC(15,4) | Consumption –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (0-1) |
| `accessibility_score` | NUMERIC(15,4) | Accessibility –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (0-1) |
| `climate_score` | NUMERIC(15,4) | Climate –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (0-1) |
| `mobility_score` | NUMERIC(15,4) | Mobility –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (0-1, placeholder) |
| `ndi_score` | NUMERIC(15,4) | –§–∏–Ω–∞–ª—å–Ω—ã–π NDI (0-1) |
| `ndi_10` | NUMERIC(15,2) | –§–∏–Ω–∞–ª—å–Ω—ã–π NDI (0-10) |
| `ndi_rank` | BIGINT | –†–∞–Ω–≥ (1 = –ª—É—á—à–∏–π) |
| `avg_hdd_yearly` | NUMERIC | HDD –∑–∞ –≥–æ–¥ (–∫–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞) |

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –¢–û–ü-10 –ø–æ—Å–µ–ª–µ–Ω–∏–π

```sql
SELECT
    ndi_rank,
    settlement_name,
    region_name,
    ndi_10
FROM sberindex.vw_ndi_calculation
ORDER BY ndi_10 DESC
LIMIT 10;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
 ndi_rank |   settlement_name    |         region_name          | ndi_10
----------+----------------------+------------------------------+--------
        1 | –ø–≥—Ç –ù–∞–¥–≤–æ–∏—Ü—ã         | –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–∞—Ä–µ–ª–∏—è           |   7.09
        2 | –ø–≥—Ç –ë–∞—Ä—Å–æ–≤–æ          | –•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –ê–û - –Æ–≥—Ä–∞   |   6.89
        3 | –ø–æ—Å—ë–ª–æ–∫ –°–æ–ª–Ω–µ—á–Ω—ã–π    | –•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –ê–û - –Æ–≥—Ä–∞   |   6.71
        4 | –ø–≥—Ç –ë–µ–ª—ã–π –Ø—Ä         | –•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –ê–û - –Æ–≥—Ä–∞   |   6.50
        5 | —Å–µ–ª–æ –Ø—Ä–µ–Ω—Å–∫          | –ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å        |   6.41
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º

```sql
SELECT
    region_name,
    COUNT(*) as settlements_count,
    ROUND(AVG(ndi_10)::numeric, 2) as avg_ndi,
    ROUND(MAX(ndi_10)::numeric, 2) as max_ndi
FROM sberindex.vw_ndi_calculation
GROUP BY region_name
ORDER BY avg_ndi DESC;
```

### –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –ø–æ—Å–µ–ª–µ–Ω–∏–π

```sql
SELECT
    CASE
        WHEN ndi_10 >= 7.0 THEN '–õ–∏–¥–µ—Ä—ã (7.0+)'
        WHEN ndi_10 >= 6.0 THEN '–£—Å–ø–µ—à–Ω—ã–µ (6.0-7.0)'
        WHEN ndi_10 >= 5.0 THEN '–°—Ä–µ–¥–Ω–∏–µ (5.0-6.0)'
        WHEN ndi_10 >= 4.0 THEN '–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ (4.0-5.0)'
        ELSE '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (<4.0)'
    END as cluster,
    COUNT(*) as settlements_count
FROM sberindex.vw_ndi_calculation
GROUP BY cluster
ORDER BY MIN(ndi_10) DESC;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
       cluster        | settlements_count
----------------------+-------------------
 –õ–∏–¥–µ—Ä—ã (7.0+)        |                 1
 –£—Å–ø–µ—à–Ω—ã–µ (6.0-7.0)   |                 6
 –°—Ä–µ–¥–Ω–∏–µ (5.0-6.0)    |                18
 –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ (4.0-5.0) |                63
 –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (<4.0)   |                40
```

### –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```sql
SELECT
    'Climate vs NDI' as pair,
    ROUND(CORR(climate_score, ndi_10)::numeric, 3) as correlation
FROM sberindex.vw_ndi_calculation;
```

### –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV

```bash
psql -d platform -U bot_etl_user2 -c "\copy (SELECT * FROM sberindex.vw_ndi_calculation ORDER BY ndi_10 DESC) TO 'ndi_full_export.csv' CSV HEADER"
```

---

## –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏

### 1. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º

- **–õ–∏–¥–µ—Ä—ã (7.0+):** 1 –ù–ü (0.8%) ‚Äî –ø–≥—Ç –ù–∞–¥–≤–æ–∏—Ü—ã
- **–£—Å–ø–µ—à–Ω—ã–µ (6.0-7.0):** 6 –ù–ü (4.7%) ‚Äî –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –•–ú–ê–û
- **–°—Ä–µ–¥–Ω–∏–µ (5.0-6.0):** 18 –ù–ü (14.1%)
- **–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ (4.0-5.0):** 63 –ù–ü (49.2%) ‚Äî **–ø–æ—á—Ç–∏ –ø–æ–ª–æ–≤–∏–Ω–∞!**
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (<4.0):** 40 –ù–ü (31.3%) ‚Äî **—Ç—Ä–µ—Ç—å –≤—Å–µ—Ö –ù–ü**

### 2. –¢–æ–ø-—Ä–µ–≥–∏–æ–Ω—ã –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É NDI

1. **–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –ê–û:** 5.11 (30 –ù–ü)
2. **–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–∞—Ä–µ–ª–∏—è:** 4.71 (8 –ù–ü)
3. **–ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å:** 4.60 (14 –ù–ü)
4. **–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–æ–º–∏:** 4.40 (25 –ù–ü)
5. **–Ø–º–∞–ª–æ-–ù–µ–Ω–µ—Ü–∫–∏–π –ê–û:** 4.39 (11 –ù–ü)

### 3. –ê—É—Ç—Å–∞–π–¥–µ—Ä—ã

- **–ß—É–∫–æ—Ç—Å–∫–∏–π –ê–û:** —Å—Ä–µ–¥–Ω–∏–π NDI 2.79 (4 –ù–ü, –º–∏–Ω–∏–º—É–º 1.68)
- **–†–µ—Å–ø—É–±–ª–∏–∫–∞ –°–∞—Ö–∞ (–Ø–∫—É—Ç–∏—è):** —Å—Ä–µ–¥–Ω–∏–π NDI 3.04 (11 –ù–ü)
- **–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∏–π –∫—Ä–∞–π:** —Å—Ä–µ–¥–Ω–∏–π NDI 3.53 (12 –ù–ü)

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

1. **POAD:** Min-Max –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ `attractiveness_v1`
2. **Market Access:** Min-Max –ø–æ 128 –∞—Ä–∫—Ç–∏—á–µ—Å–∫–∏–º –ù–ü (–ù–ï –ø–æ –≤—Å–µ–º 2000 –ú–û!)
3. **Consumption:** `(–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ / –ø—Ä–æ–∂–∏—Ç_–º–∏–Ω–∏–º—É–º) / 2.0`, clip at 2.0
4. **Accessibility:** –ü—Ä—è–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ `accessibility_scores`
5. **Climate:** `1 - (HDD_normalized)` ‚Äî –∏–Ω–≤–µ—Ä—Å–∏—è, —Ç.–∫. —Ö–æ–ª–æ–¥ = –ø–ª–æ—Ö–æ
6. **Mobility:** Placeholder 0.5 (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL)

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–ø—É—Å–∫–æ–≤

- **Market Access:** –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Å—Ä–µ–¥–Ω–∏–º–∏ —á–µ—Ä–µ–∑ `AVG(...) OVER (PARTITION BY region_id)`
- **Consumption:** –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Å—Ä–µ–¥–Ω–∏–º–∏
- **–û—Å—Ç–∞–ª—å–Ω—ã–µ:** `COALESCE(..., 0.5)` ‚Äî –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

---

## –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞

```
sberbank_hackaton_11_2025/
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ 12_load_ndi_components_to_postgres.py  # –ó–∞–≥—Ä—É–∑–∫–∞ POAD –∏ Accessibility
‚îÇ   ‚îú‚îÄ‚îÄ 12_create_ndi_view.sql                 # –°–æ–∑–¥–∞–Ω–∏–µ VIEW
‚îÇ   ‚îî‚îÄ‚îÄ utils_csv_to_postgres.py               # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —É—Ç–∏–ª–∏—Ç–∞
‚îÇ
‚îú‚îÄ‚îÄ arctic/results/
‚îÇ   ‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ attractiveness_v1.csv              # POAD scores
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ accessibility_scores.csv           # Accessibility scores
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ndi_final.csv                      # Python —Ä–∞—Å—á—ë—Ç (–¥–ª—è —Å–≤–µ—Ä–∫–∏)
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ analysis/
‚îÇ       ‚îú‚îÄ‚îÄ ndi_sql_queries.sql                # 10 –ø–æ–ª–µ–∑–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
‚îÇ       ‚îú‚îÄ‚îÄ ndi_validation_fixed.sql           # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞—Å—á—ë—Ç–∞
‚îÇ       ‚îî‚îÄ‚îÄ NDI_VIEW_README.md                 # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

---

## –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å

**–®–∞–≥–∏ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:**

1. –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ü–û–†–ê –≤ PostgreSQL (—Å–∫—Ä–∏–ø—Ç—ã 01-04)
2. –†–∞—Å—á—ë—Ç POAD attractiveness_v1 (—Å–∫—Ä–∏–ø—Ç 05)
3. –†–∞—Å—á—ë—Ç accessibility scores (—Å–∫—Ä–∏–ø—Ç 07)
4. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö (—Å–∫—Ä–∏–ø—Ç—ã 09-10)
5. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –°–±–µ—Ä–ò–Ω–¥–µ–∫—Å–∞ (consumption, market_access)
6. **–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≤ PostgreSQL** (—Å–∫—Ä–∏–ø—Ç 12_load_ndi_components)
7. **–°–æ–∑–¥–∞–Ω–∏–µ VIEW** (—Å–∫—Ä–∏–ø—Ç 12_create_ndi_view.sql)

**–í–∞–ª–∏–¥–∞—Ü–∏—è:** –†–µ–∑—É–ª—å—Ç–∞—Ç—ã VIEW **–∏–¥–µ–Ω—Ç–∏—á–Ω—ã** Python —Ä–∞—Å—á—ë—Ç—É –∏–∑ `11_calculate_ndi.py`

---

## –õ–∏—Ü–µ–Ω–∑–∏—è –∏ –∞–≤—Ç–æ—Ä—Å—Ç–≤–æ

- **–î–∞–Ω–Ω—ã–µ –ü–û–†–ê:** –ú–ì–£, –†–æ—Å—Å—Ç–∞—Ç, –ë–î–ü–ú–û
- **–î–∞–Ω–Ω—ã–µ –°–±–µ—Ä–ò–Ω–¥–µ–∫—Å:** –°–±–µ—Ä–±–∞–Ω–∫, –ª–∏—Ü–µ–Ω–∑–∏—è CC BY-SA 4.0
- **–ö–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ:** Open-Meteo API (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)
- **–°–∫—Ä–∏–ø—Ç—ã —Ä–∞—Å—á—ë—Ç–∞:** –°–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —Ö–∞–∫–∞—Ç–æ–Ω–∞ Sberbank 11/2025

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-11-12
**–í–µ—Ä—Å–∏—è:** 1.0
