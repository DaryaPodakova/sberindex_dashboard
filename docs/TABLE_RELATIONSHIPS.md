# Отчет о таблицах схемы sberindex и их взаимосвязях

## Справочные таблицы (Dictionaries)

### dict_regions
Содержит 10 регионов РФ с уникальными идентификаторами. Является корневой таблицей для географической иерархии - связывается с dict_municipalities и dict_settlements через region_id. Используется для агрегации данных на региональном уровне, сравнения показателей между субъектами РФ и фильтрации населённых пунктов по регионам. Ключевое поле для JOIN: region_id.

### dict_municipalities
Хранит 192 муниципальных образования двух уровней (upper/lower) с привязкой к регионам и кодами ОКТМО. Связывается с dict_regions (parent) и dict_settlements (child) через municipality_up_id/municipality_down_id. Позволяет анализировать данные на уровне городских округов и муниципальных районов, строить иерархию территориального деления и сопоставлять показатели между муниципалитетами разных уровней.

### dict_settlements
Центральная таблица географических справочников, содержащая 128 населённых пунктов с привязкой к регионам и муниципалитетам. Связывается с dict_regions, dict_municipalities, meta_* таблицами и fact_settlement_indicators через settlement_id. Служит основой для всех аналитических запросов по НП, позволяет фильтровать данные по типу поселения, строить территориальные срезы и детализировать показатели до уровня конкретного населённого пункта.

### dict_data_blocks
Справочник 10 блоков данных (ИНСТРУМЕНТАЛЬНЫЕ, ИНФРАСТРУКТУРА, ЗДРАВООХРАНЕНИЕ и др.). Связывается с dict_indicators через block_id для категоризации показателей по тематическим группам. Используется для построения аналитических отчётов по блокам показателей, расчёта агрегированных метрик по направлениям и создания тематических дашбордов.

### dict_rating_domains
Содержит 9 доменов рейтинга (ДОХОДЫ, ЖИЛЬЕ, ОБРАЗОВАНИЕ и др.) для структурирования показателей по сферам оценки. Связывается с dict_indicators и через них с fact_settlement_indicators. Позволяет проводить многомерный анализ населённых пунктов по различным доменам, сравнивать рейтинги и строить интегральные индексы качества жизни.

### dict_data_sources
Справочник 6 источников данных (BDPMO, ROSSTAT, форма и др.) с указанием типа доступа и формата получения. Связывается с dict_indicators через source_id для отслеживания происхождения показателей. Используется для оценки надёжности данных, планирования обновлений из внешних источников и документирования методологии сбора показателей.

### dict_indicators
Ключевая таблица справочников - 93 показателя с описаниями, акронимами, методами расчёта и нормализации. Связывает dict_data_blocks, dict_rating_domains, dict_data_sources с fact_settlement_indicators через indicator_id. Является центральным элементом для любой аналитики показателей - позволяет получать метаданные, фильтровать факты по типу показателя, строить отчёты с человекочитаемыми названиями вместо технических акронимов.

### dict_esg_blocks
Содержит 9 ESG блоков и целей устойчивого развития ООН с номерами целей. Связывается с dict_indicators через link_indicator_esg (many-to-many связь) для маркировки показателей по ESG критериям. Позволяет проводить ESG-аналитику населённых пунктов, оценивать прогресс по целям устойчивого развития и строить ESG-рейтинги территорий.

---

## Метаданные (Meta Tables)

### meta_settlement_attributes
Хранит 128 записей с булевыми характеристиками НП (is_arctic, is_remote, is_special, is_suburb). Связывается с dict_settlements один-к-одному через settlement_id. Используется для сегментации населённых пунктов по категориям, фильтрации арктических/отдалённых территорий, сравнительного анализа показателей между различными типами НП и построения специализированных отчётов для особых территорий.

### meta_settlement_coordinates
Содержит географические координаты (широта/долгота) для 128 НП с указанием источника данных. Связывается с dict_settlements через settlement_id для геопространственной аналитики. Позволяет строить карты, рассчитывать расстояния между НП, проводить пространственный анализ распределения показателей, создавать heat maps и визуализировать территориальные паттерны.

### meta_settlement_population
Демографические данные 128 НП (общая численность, мужчины, женщины) с возможностью версионирования по годам. Связывается с dict_settlements через settlement_id для расчёта удельных показателей. Используется для нормализации абсолютных значений на душу населения, анализа демографической структуры, расчёта гендерных соотношений и построения демографических трендов.

---

## Фактовые таблицы (Fact Tables)

### fact_settlement_indicators
Центральная фактовая таблица - 8,159 нормализованных записей показателей по НП с поддержкой трёх типов значений (numeric, text, boolean). Связывается с dict_settlements и dict_indicators через settlement_id и indicator_id, образуя звезду схемы (star schema). Является основой всей аналитики - позволяет выполнять агрегации, сравнения, ранжирования, расчёт производных метрик, временной анализ (через year) и построение любых аналитических отчётов путём JOIN с справочниками и метаданными.

### link_indicator_esg
Связующая таблица many-to-many между показателями и ESG блоками с опциональным весом показателя. Связывает dict_indicators и dict_esg_blocks для построения ESG-моделей. Позволяет определять какие показатели относятся к каким целям устойчивого развития, рассчитывать взвешенные ESG-индексы, проводить gap-анализ по ESG критериям и строить многомерные оценки территорий.

### audit_settlement_indicators
Журнал аудита изменений данных с историей старых и новых значений, типом операции и временными метками. Связывается с fact_settlement_indicators через fact_id для отслеживания истории. Используется для анализа динамики изменений показателей, выявления аномалий в обновлениях данных, восстановления исторических значений и обеспечения data governance процессов.

---

## Основные паттерны соединений для аналитики

### 1. Полная детализация показателя по НП
```sql
fact_settlement_indicators
  → dict_settlements (территория)
  → dict_indicators (метаданные показателя)
  → dict_regions (регион)
  → meta_settlement_population (для расчёта per capita)
```
**Использование:** Получение детального значения показателя с контекстом территории, региона и возможностью нормализации на население.

### 2. Иерархическая агрегация по территориям
```sql
fact_settlement_indicators
  → dict_settlements → dict_municipalities → dict_regions
```
**Использование:** Агрегация показателей снизу вверх - от населённых пунктов к муниципалитетам и регионам для построения территориальных сводок.

### 3. Тематический анализ показателей
```sql
fact_settlement_indicators
  → dict_indicators → dict_data_blocks / dict_rating_domains
```
**Использование:** Группировка и анализ показателей по тематическим блокам (здравоохранение, образование) или доменам рейтинга (доходы, жильё).

### 4. ESG-аналитика
```sql
fact_settlement_indicators
  → dict_indicators → link_indicator_esg → dict_esg_blocks
```
**Использование:** Оценка населённых пунктов по критериям ESG и целям устойчивого развития с учётом весов показателей.

### 5. Геопространственный анализ
```sql
fact_settlement_indicators
  → dict_settlements → meta_settlement_coordinates + meta_settlement_attributes
```
**Использование:** Построение карт с визуализацией показателей, фильтрация арктических/отдалённых территорий, пространственная кластеризация.

### 6. Сравнительный анализ категорий НП
```sql
fact_settlement_indicators
  → dict_settlements (settlement_type)
  → meta_settlement_attributes (is_arctic, is_remote)
  → meta_settlement_population
```
**Использование:** Сравнение средних показателей между типами НП (города vs поселки), арктическими vs неарктическими, с учётом демографии.

---

## Ключевые преимущества архитектуры

**Нормализация:** Данные разделены на факты и измерения (star schema), что исключает дублирование и обеспечивает консистентность справочников.

**Масштабируемость:** Добавление новых показателей требует только вставки строк в fact_settlement_indicators, без изменения структуры таблиц.

**Гибкость:** Поддержка трёх типов значений (numeric, text, boolean) в фактовой таблице позволяет хранить любые виды показателей.

**Производительность:** Индексы на settlement_id, indicator_id, year обеспечивают быстрые JOIN и агрегации; композитные индексы ускоряют аналитические запросы.

**Аудит:** Триггеры updated_at и таблица audit_settlement_indicators обеспечивают прозрачность изменений данных.

**Версионирование:** Поле year в фактовой таблице позволяет хранить временные ряды и анализировать динамику показателей.
